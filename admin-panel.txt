<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; cursor: pointer; border-radius: 4px; }
        button:hover { background: #0056b3; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 50px auto; padding: 20px; width: 90%; max-width: 500px; border-radius: 8px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .close { float: right; font-size: 28px; cursor: pointer; }
        table { width: 100%; border-collapse: collapse; background: white; margin-top: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        th, td { padding: 16px; text-align: left; border-bottom: 1px solid #e0e0e0; }
        th { background: #1976d2; color: white; font-weight: 600; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.5px; }
        td { font-size: 0.875rem; }
        tr:hover { background: #f5f5f5; }
        tbody tr { transition: background 0.2s; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Admin Management</h1>
        <div style="margin-bottom: 20px;">
            <button onclick="openModal()">Add Admin</button>
            <button onclick="refreshAllData()" style="margin-left: 10px; background: #28a745;">Refresh All Data</button>
        </div>

        <table id="adminTable">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Total Consumption</th>
                    <th>Subscription Date</th>
                    <th>Validity Date</th>
                    <th>Subscribers Count</th>
                    <th>Admin Consumption</th>
                    <th>Balance</th>
                    <th>Expiration</th>
                    <th>Last Update</th>
                    <th>View Details</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="adminTableBody"></tbody>
        </table>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>Add Admin</h2>
            <form id="adminForm">
                <div class="form-group">
                    <label>Full Name:</label>
                    <input type="text" name="fullName" required>
                </div>
                <div class="form-group">
                    <label>Phone Number:</label>
                    <input type="text" name="phoneNumber" required>
                </div>
                <div class="form-group">
                    <label>Admin Quota:</label>
                    <input type="text" name="adminQuota" required>
                </div>
                <div class="form-group">
                    <label>Password:</label>
                    <input type="password" name="password" required>
                </div>
                <div class="form-group">
                    <label>Type:</label>
                    <select name="type" required>
                        <option value="open">Open</option>
                        <option value="closed">Closed</option>
                    </select>
                </div>
                <button type="submit">Save</button>
            </form>
        </div>
    </div>

    <script>
        function openModal() {
            document.getElementById('modal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
            document.getElementById('adminForm').reset();
        }

        document.getElementById('adminForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);

            try {
                const response = await fetch('http://localhost:3000/add-admin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                if (result.success) {
                    alert(result.warning ? '‚ö†Ô∏è ' + result.message : '‚úÖ ' + result.message);
                    closeModal();
                    setTimeout(() => {
                        loadAdmins();
                    }, 1000);
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        });

        async function loadAdmins() {
            try {
                const response = await fetch('http://localhost:3000/get-admins');
                const admins = await response.json();
                
                const tbody = document.getElementById('adminTableBody');
                tbody.innerHTML = '';
                
                admins.forEach(admin => {
                    const row = tbody.insertRow();
                    
                    const dashboard = admin.dashboardData || {};
                    const amounts = dashboard.amounts || [];
                    const dates = dashboard.dates || [];
                    
                    // Debug: log balance value
                    console.log('üîç Admin:', admin.fullName || admin.phoneNumber);
                    console.log('   dashboard.balance:', dashboard.balance);
                    console.log('   dashboard keys:', Object.keys(dashboard));
                    
                    // Extract data from consumption circles and API
                    let totalConsumption = '-';
                    let adminConsumption = '-';
                    let balance = '-';
                    let expiryDate = dashboard.expiryDate || '-';
                    
                    // IMPORTANT: Check primaryData.CurrentBalanceValue FIRST (this is where API stores it)
                    if (dashboard.primaryData && dashboard.primaryData.CurrentBalanceValue) {
                        balance = dashboard.primaryData.CurrentBalanceValue;
                        console.log('   ‚úÖ Found balance in primaryData.CurrentBalanceValue:', balance);
                    } else if (dashboard.balance) {
                        balance = dashboard.balance;
                        console.log('   ‚úÖ Found balance in dashboard.balance:', balance);
                    } else {
                        // More detailed debugging
                        console.log('   ‚ö†Ô∏è Balance not found for:', admin.fullName || admin.phoneNumber);
                        console.log('   dashboard.balance:', dashboard.balance);
                        console.log('   primaryData exists?', !!dashboard.primaryData);
                        if (dashboard.primaryData) {
                            console.log('   primaryData keys:', Object.keys(dashboard.primaryData));
                            console.log('   primaryData type:', typeof dashboard.primaryData);
                            console.log('   CurrentBalanceValue:', dashboard.primaryData.CurrentBalanceValue);
                            // Try to see if balance is in a different structure
                            console.log('   primaryData full:', JSON.stringify(dashboard.primaryData).substring(0, 200));
                        }
                        // Check if balance might be in a different field
                        console.log('   All dashboard keys:', Object.keys(dashboard));
                        console.log('   Full dashboard object:', JSON.stringify(dashboard, null, 2).substring(0, 500));
                        if (dashboard.amounts && dashboard.amounts.length > 0) {
                            console.log('   amounts[0]:', dashboard.amounts[0]);
                            // Try to use amounts as fallback
                            if (balance === '-') {
                                balance = dashboard.amounts[0];
                                console.log('   Using amounts[0] as balance:', balance);
                            }
                        }
                    }
                    // Extract Subscription Date and Validity Date from getmyservices API
                    // Subscription Date = ActivationDate from getmyservices response (array, find object with non-null ActivationDate)
                    // Validity Date = CycleDate from getmyservices response (array, find object with non-null CycleDate)
                    // Format: DD/MM/YYYY (e.g., 13/10/2025)
                    let subscriptionDate = '-';
                    let validityDate = '-';
                    
                    console.log('üîç Extracting Subscription Date and Validity Date from getmyservices API...');
                    
                    // Helper function to format date as DD/MM/YYYY
                    function formatDate(dateString) {
                        if (!dateString) return null;
                        try {
                            const date = new Date(dateString);
                            const day = String(date.getDate()).padStart(2, '0');
                            const month = String(date.getMonth() + 1).padStart(2, '0');
                            const year = date.getFullYear();
                            return `${day}/${month}/${year}`;
                        } catch (e) {
                            console.log('   ‚ùå Error parsing date:', dateString, e);
                            return null;
                        }
                    }
                    
                    // Try to find getmyservices response in apiResponses
                    if (dashboard.apiResponses && Array.isArray(dashboard.apiResponses)) {
                        const getMyServicesResponse = dashboard.apiResponses.find(resp => resp.url && resp.url.includes('getmyservices'));
                        if (getMyServicesResponse && getMyServicesResponse.data) {
                            const myServicesData = getMyServicesResponse.data;
                            console.log('   ‚úÖ Found getmyservices response');
                            
                            // getmyservices response is an array, find the object with non-null ActivationDate and CycleDate
                            if (Array.isArray(myServicesData)) {
                                // Find the first object with non-null ActivationDate
                                const serviceWithActivation = myServicesData.find(service => service.ActivationDate);
                                if (serviceWithActivation && serviceWithActivation.ActivationDate) {
                                    const formatted = formatDate(serviceWithActivation.ActivationDate);
                                    if (formatted) {
                                        subscriptionDate = formatted;
                                        console.log('   ‚úÖ Extracted Subscription Date (ActivationDate):', subscriptionDate);
                                    }
                                } else {
                                    console.log('   ‚ö†Ô∏è No service with ActivationDate found in getmyservices array');
                                }
                                
                                // Find the first object with non-null CycleDate
                                const serviceWithCycle = myServicesData.find(service => service.CycleDate);
                                if (serviceWithCycle && serviceWithCycle.CycleDate) {
                                    const formatted = formatDate(serviceWithCycle.CycleDate);
                                    if (formatted) {
                                        validityDate = formatted;
                                        console.log('   ‚úÖ Extracted Validity Date (CycleDate):', validityDate);
                                    }
                                } else {
                                    console.log('   ‚ö†Ô∏è No service with CycleDate found in getmyservices array');
                                }
                            } else if (myServicesData.ActivationDate || myServicesData.CycleDate) {
                                // If it's not an array but an object with dates
                                if (myServicesData.ActivationDate) {
                                    const formatted = formatDate(myServicesData.ActivationDate);
                                    if (formatted) {
                                        subscriptionDate = formatted;
                                        console.log('   ‚úÖ Extracted Subscription Date (ActivationDate):', subscriptionDate);
                                    }
                                }
                                if (myServicesData.CycleDate) {
                                    const formatted = formatDate(myServicesData.CycleDate);
                                    if (formatted) {
                                        validityDate = formatted;
                                        console.log('   ‚úÖ Extracted Validity Date (CycleDate):', validityDate);
                                    }
                                }
                            } else {
                                console.log('   ‚ö†Ô∏è getmyservices data is not an array and has no ActivationDate/CycleDate');
                            }
                        } else {
                            console.log('   ‚ö†Ô∏è getmyservices response not found in apiResponses');
                        }
                    } else {
                        console.log('   ‚ö†Ô∏è dashboard.apiResponses is not available');
                    }
                    
                    let subscribersCount = '-';
                    // Extract Expiration from getexpirydate API
                    // Expiration = number of days remaining from getexpirydate API response
                    // API URL: https://www.alfa.com.lb/en/account/getexpirydate
                    // Response: Just a number (e.g., "54")
                    // HTML fallback: #expiry-date-value element
                    let expiration = '-';
                    
                    console.log('üîç Extracting Expiration (days remaining) from getexpirydate API...');
                    
                    // Try to find getexpirydate response in apiResponses
                    if (dashboard.apiResponses && Array.isArray(dashboard.apiResponses)) {
                        const getExpiryDateResponse = dashboard.apiResponses.find(resp => resp.url && resp.url.includes('getexpirydate'));
                        if (getExpiryDateResponse && getExpiryDateResponse.data !== undefined && getExpiryDateResponse.data !== null) {
                            // The API response is just a number (string or number)
                            const expiryDays = getExpiryDateResponse.data;
                            if (expiryDays !== null && expiryDays !== undefined && expiryDays !== '') {
                                expiration = String(expiryDays).trim();
                                console.log('   ‚úÖ Extracted Expiration from getexpirydate API:', expiration);
                            } else {
                                console.log('   ‚ö†Ô∏è getexpirydate response is empty');
                            }
                        } else {
                            console.log('   ‚ö†Ô∏è getexpirydate response not found in apiResponses');
                        }
                    } else {
                        console.log('   ‚ö†Ô∏è dashboard.apiResponses is not available');
                    }
                    
                    // lastDataFetch is stored at admin level, not inside dashboardData
                    let lastUpdate = admin.lastDataFetch || dashboard.lastDataFetch || dashboard.lastUpdated || '-';
                    let status = 'active';
                    
                    // Extract Total Consumption - Priority: API, then fallback to consumptions array
                    if (dashboard.totalConsumption) {
                        totalConsumption = dashboard.totalConsumption;
                        console.log('   ‚úÖ Using totalConsumption from API:', totalConsumption);
                    } else if (dashboard.consumptions && dashboard.consumptions.length > 0) {
                        // FALLBACK: Extract from consumptions array (like balance extraction)
                        // Total consumption = the one with "U-Share Total Bundle" or highest total
                        console.log('   ‚ö†Ô∏è totalConsumption not in API, extracting from consumptions array...');
                        const totalConsumptionItem = dashboard.consumptions.find(c => 
                            c.planName && c.planName.includes('Total Bundle')
                        ) || dashboard.consumptions.find(c => 
                            c.total && parseFloat(c.total) >= 70 // Usually the 77 GB one
                        ) || dashboard.consumptions[1]; // Second item is usually total
                        
                        if (totalConsumptionItem && totalConsumptionItem.usage) {
                            totalConsumption = totalConsumptionItem.usage;
                            console.log('   ‚úÖ Extracted totalConsumption from consumptions:', totalConsumption);
                        } else {
                            totalConsumption = '-';
                        }
                    } else {
                        totalConsumption = '-';
                    }
                    
                    // Extract secondary subscribers for "View Details" column
                    let viewDetails = '-';
                    if (dashboard.secondarySubscribers && Array.isArray(dashboard.secondarySubscribers) && dashboard.secondarySubscribers.length > 0) {
                        viewDetails = dashboard.secondarySubscribers.map(sub => sub.consumption).join(', ');
                        console.log('   ‚úÖ Found secondarySubscribers from API:', viewDetails);
                    } else if (dashboard.consumptions && dashboard.consumptions.length > 2) {
                        // FALLBACK: Extract from consumptions array (skip first 2: admin + total)
                        console.log('   ‚ö†Ô∏è secondarySubscribers not in API, extracting from consumptions array...');
                        const secondaryItems = dashboard.consumptions.slice(2); // Skip admin (index 0) and total (index 1)
                        if (secondaryItems.length > 0) {
                            viewDetails = secondaryItems.map(c => c.usage || `${c.used} / ${c.total}`).join(', ');
                            console.log('   ‚úÖ Extracted secondary subscribers from consumptions:', viewDetails);
                        }
                    }
                    
                    // Admin Consumption = U-share Main circle used / admin quota (user-entered quota)
                    // Format: "used / quota" (e.g., "13 / 15") - ONLY NUMBERS, NO UNITS
                    // Before "/": Just the number from consumptions[0].used (e.g., "13" or "14.66")
                    // After "/": Just the number from admin.adminQuota (e.g., "15" - extract number only)
                    console.log('üîçüîçüîç DEBUG Admin Consumption Extraction:');
                    console.log('   dashboard.consumptions:', dashboard.consumptions);
                    console.log('   dashboard.consumptions[0]:', dashboard.consumptions?.[0]);
                    console.log('   admin.adminQuota:', admin.adminQuota);
                    
                    if (dashboard.consumptions && dashboard.consumptions.length > 0 && admin.adminQuota) {
                        const primaryConsumption = dashboard.consumptions[0]; // U-share Main circle (first circle)
                        console.log('   primaryConsumption.full:', JSON.stringify(primaryConsumption));
                        console.log('   primaryConsumption.used:', primaryConsumption.used);
                        console.log('   primaryConsumption.usage:', primaryConsumption.usage);
                        console.log('   primaryConsumption.total:', primaryConsumption.total);
                        
                        // Extract just the number from used (before "/")
                        // primaryConsumption.used should be just a number like "13" or "14.66"
                        let adminUsed = null;
                        if (primaryConsumption.used !== undefined && primaryConsumption.used !== null) {
                            const usedStr = String(primaryConsumption.used).trim();
                            // Extract first number found - handle cases where it might have extra text
                            const numberMatch = usedStr.match(/^([\d.]+)/);
                            if (numberMatch) {
                                adminUsed = numberMatch[1]; // Just the number (e.g., "13" or "14.66")
                                console.log('   ‚úÖ Extracted adminUsed:', adminUsed);
                            } else {
                                console.log('   ‚ùå Could not extract number from primaryConsumption.used:', primaryConsumption.used);
                                // Try to extract from usage if used doesn't work
                                if (primaryConsumption.usage) {
                                    const usageMatch = String(primaryConsumption.usage).match(/^([\d.]+)/);
                                    if (usageMatch) {
                                        adminUsed = usageMatch[1];
                                        console.log('   ‚úÖ Extracted adminUsed from usage:', adminUsed);
                                    }
                                }
                            }
                        } else {
                            console.log('   ‚ö†Ô∏è primaryConsumption.used is missing, trying usage field');
                            // Fallback to usage field if used doesn't exist
                            if (primaryConsumption.usage) {
                                const usageStr = String(primaryConsumption.usage).trim();
                                const usageMatch = usageStr.match(/^([\d.]+)/);
                                if (usageMatch) {
                                    adminUsed = usageMatch[1];
                                    console.log('   ‚úÖ Extracted adminUsed from usage field:', adminUsed);
                                }
                            }
                        }
                        
                        // Extract just the number from adminQuota (after "/")
                        let adminQuotaNum = null;
                        if (admin.adminQuota) {
                            const quotaStr = String(admin.adminQuota).trim();
                            const numberMatch = quotaStr.match(/^([\d.]+)/); // Get first number
                            if (numberMatch) {
                                adminQuotaNum = numberMatch[1]; // Just the number (e.g., "15")
                                console.log('   ‚úÖ Extracted adminQuotaNum:', adminQuotaNum);
                            } else {
                                console.log('   ‚ùå Could not extract number from adminQuota:', admin.adminQuota);
                            }
                        }
                        
                        if (adminUsed && adminQuotaNum) {
                            // Format: "number / number" (e.g., "13 / 15") - NO UNITS
                            adminConsumption = `${adminUsed} / ${adminQuotaNum}`;
                            console.log('‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ Built adminConsumption (numbers only):', adminConsumption);
                            console.log('   Final: U-share Main used (before /):', adminUsed);
                            console.log('   Final: Admin quota number (after /):', adminQuotaNum);
                        } else {
                            console.log('‚ùå‚ùå‚ùå Missing data for adminConsumption:');
                            console.log('   adminUsed:', adminUsed);
                            console.log('   adminQuotaNum:', adminQuotaNum);
                            adminConsumption = '-';
                        }
                    } else {
                        console.log('‚ùå‚ùå‚ùå Cannot build adminConsumption:');
                        console.log('   Has consumptions:', !!dashboard.consumptions);
                        console.log('   Consumptions length:', dashboard.consumptions?.length || 0);
                        console.log('   Has adminQuota:', !!admin.adminQuota);
                        adminConsumption = '-';
                    }
                    
                    // Subscribers count = Count of "U-share secondary" circles in the dashboard
                    // Count how many consumption circles have planName containing "U-share secondary"
                    console.log('üîç Counting U-share secondary circles from consumptions array...');
                    let uShareSecondaryCount = 0;
                    
                    if (dashboard.consumptions && Array.isArray(dashboard.consumptions)) {
                        dashboard.consumptions.forEach((consumption, index) => {
                            const planName = consumption.planName || '';
                            console.log(`   Circle ${index}: planName = "${planName}"`);
                            // Check if planName contains "U-share secondary" (case-insensitive)
                            if (planName && planName.toLowerCase().includes('u-share secondary')) {
                                uShareSecondaryCount++;
                                console.log(`   ‚úÖ Found U-share secondary circle at index ${index}`);
                            }
                        });
                        console.log(`   ‚úÖ‚úÖ‚úÖ Total U-share secondary circles found: ${uShareSecondaryCount}`);
                    } else {
                        console.log('   ‚ö†Ô∏è dashboard.consumptions is not available');
                    }
                    
                    // Use the count from circles, or fallback to dashboard.subscribersCount if available
                    if (uShareSecondaryCount > 0) {
                        subscribersCount = uShareSecondaryCount.toString();
                        console.log('   ‚úÖ‚úÖ‚úÖ Using subscribersCount from circle count:', subscribersCount);
                    } else if (dashboard.subscribersCount !== undefined && dashboard.subscribersCount !== null) {
                        subscribersCount = dashboard.subscribersCount.toString();
                        console.log('   ‚úÖ Using subscribersCount from dashboard (fallback):', subscribersCount);
                    } else {
                        subscribersCount = '-';
                        console.log('   ‚ùå No subscribers count found');
                    }
                    
                    // Get validity/expiry from first consumption if available
                    if (dashboard.consumptions && dashboard.consumptions.length > 0) {
                        const primaryConsumption = dashboard.consumptions[0];
                        if (!validityDate && primaryConsumption && primaryConsumption.phoneNumber) {
                            // Try to find validity in dates array
                            if (dates.length > 0) {
                                validityDate = dates[0];
                                expiration = dates[0];
                            }
                        }
                    }
                    
                    // Balance is already checked above, now extract other fields from primaryData
                    // NOTE: totalConsumption should already be set from dashboard.totalConsumption above
                    // Don't override it here with wrong data!
                    if (dashboard.primaryData) {
                        const apiData = dashboard.primaryData;
                        
                        // Continue with API data extraction for other fields (but NOT totalConsumption - it's already set correctly)
                        if (apiData.ServiceInformationValue && apiData.ServiceInformationValue.length > 0) {
                            const service = apiData.ServiceInformationValue[0];
                            
                            if (service.ServiceDetailsInformationValue && service.ServiceDetailsInformationValue.length > 0) {
                                const details = service.ServiceDetailsInformationValue[0];
                                
                                // DO NOT override totalConsumption here - it's already extracted correctly from SecondaryValue[0]
                                // DO NOT set adminConsumption here - it needs adminUsed from HTML consumptions[0].used
                                // Admin consumption should be: "adminUsed / ConsumptionValue"
                                // This is already handled in alfa-automation.js
                            }
                            
                            // Extract dates if available (only if not already found)
                            if (expiryDate === '-' && service.ExpiryDateValue) {
                                expiryDate = service.ExpiryDateValue;
                                expiration = service.ExpiryDateValue;
                            }
                        }
                    }
                    
                    // Fallback to amounts/dates (only if balance is still '-')
                    if (balance === '-') {
                        balance = amounts.length > 0 ? amounts[0] : '-';
                    }
                    if (expiryDate === '-') {
                        expiryDate = dates.length > 0 ? dates[0] : '-';
                    }
                    // Set expiration from expiryDate if not already set
                    if (expiration === '-' && expiryDate !== '-') {
                        expiration = expiryDate;
                    }
                    
                    // Final debug before display
                    console.log('   Final balance before display:', balance);
                    
                    // Format last update date
                    if (lastUpdate && lastUpdate !== '-') {
                        try {
                            const date = new Date(lastUpdate);
                            const formattedDate = date.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' });
                            const formattedTime = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true });
                            lastUpdate = `${formattedDate}\n${formattedTime}`;
                        } catch (e) {
                            // Keep original format
                        }
                    }
                    
                    // Name cell (with phone number as secondary)
                    const nameCell = row.insertCell(0);
                    nameCell.innerHTML = `<div><strong>${admin.fullName || '-'}</strong><br><span style="color: #666; font-size: 0.9em;">${admin.phoneNumber || '-'}</span></div>`;
                    
                    // Total Consumption
                    const totalConsCell = row.insertCell(1);
                    totalConsCell.innerHTML = totalConsumption !== '-' ? 
                        `<div style="display: flex; align-items: center; gap: 8px;"><div style="flex: 1; background: #f0f0f0; height: 8px; border-radius: 4px; overflow: hidden;"><div style="background: #4caf50; height: 100%; width: ${calculatePercentage(totalConsumption)}%;"></div></div><span>${totalConsumption}</span></div>` :
                        '-';
                    
                    row.insertCell(2).textContent = subscriptionDate;
                    row.insertCell(3).textContent = validityDate;
                    row.insertCell(4).textContent = subscribersCount;
                    
                    // Admin Consumption - Display with progress bar
                    // CRITICAL: Use the adminConsumption we just built, NOT dashboard.adminConsumption
                    console.log('üéØüéØüéØ FINAL CHECK before displaying adminConsumption:');
                    console.log('   adminConsumption variable:', adminConsumption);
                    console.log('   dashboard.adminConsumption:', dashboard.adminConsumption);
                    console.log('   primaryConsumption.usage:', dashboard.consumptions?.[0]?.usage);
                    
                    const adminConsCell = row.insertCell(5);
                    if (adminConsumption !== '-') {
                        const percentage = calculatePercentage(adminConsumption);
                        adminConsCell.innerHTML = `<div style="display: flex; align-items: center; gap: 8px;">
                            <div style="flex: 1; background: #f0f0f0; height: 8px; border-radius: 4px; overflow: hidden;">
                                <div style="background: #ff9800; height: 100%; width: ${percentage}%;"></div>
                            </div>
                            <span>${adminConsumption}</span>
                        </div>`;
                        console.log(`   ‚úÖ‚úÖ‚úÖ Displaying adminConsumption with progress bar: ${adminConsumption} (${percentage.toFixed(1)}%)`);
                    } else {
                        adminConsCell.textContent = '-';
                        console.log('   ‚ö†Ô∏è Admin consumption is missing, displaying "-"');
                    }
                    
                    // Balance cell (ensure it displays correctly)
                    const balanceCell = row.insertCell(6);
                    balanceCell.textContent = balance !== '-' ? balance : '-';
                    // Debug: log what's being set
                    if (balance !== '-') {
                        console.log('   ‚úÖ Setting balance cell to:', balance);
                    } else {
                        console.log('   ‚ö†Ô∏è Balance is still "-", dashboard.balance was:', dashboard.balance);
                    }
                    
                    // Expiration (days remaining from getexpirydate API - just display the number)
                    const expCell = row.insertCell(7);
                    if (expiration !== '-') {
                        // Expiration is already the number of days from getexpirydate API
                        expCell.textContent = expiration;
                        console.log(`   ‚úÖ Displaying expiration (days): ${expiration}`);
                    } else {
                        expCell.textContent = '-';
                        console.log('   ‚ö†Ô∏è Expiration is missing, displaying "-"');
                    }
                    
                    // Last Update (formatted)
                    const updateCell = row.insertCell(8);
                    updateCell.innerHTML = lastUpdate !== '-' ? 
                        `<div><div>${lastUpdate.split('\n')[0]}</div><div style="color: #666; font-size: 0.85em;">${lastUpdate.split('\n')[1] || ''}</div></div>` :
                        '-';
                    
                    // View Details (secondary subscribers)
                    const viewDetailsCell = row.insertCell(9);
                    viewDetailsCell.textContent = viewDetails !== '-' ? viewDetails : '-';
                    viewDetailsCell.style.fontSize = '0.85em';
                    viewDetailsCell.style.color = '#666';
                    
                    // Status
                    const statusCell = row.insertCell(10);
                    let statusHtml = `<span style="background: #4caf50; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.85em;">${status}</span>`;
                    
                    // Add refresh button if data exists
                    if (admin.dashboardData) {
                        statusHtml += `<button onclick="refreshData('${admin.phoneNumber}', this)" style="margin-left: 8px; padding: 4px 8px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.75em;">Refresh</button>`;
                    }
                    
                    statusCell.innerHTML = statusHtml;
                });
                
                function calculatePercentage(consumptionStr) {
                    if (!consumptionStr || consumptionStr === '-') return 0;
                    const match = consumptionStr.match(/([\d.]+)\s*\/\s*([\d.]+)/);
                    if (match) {
                        const used = parseFloat(match[1]);
                        const total = parseFloat(match[2]);
                        if (total > 0) {
                            return Math.min(100, Math.max(0, (used / total) * 100));
                        }
                    }
                    return 50; // Default
                }
                
                function extractDays(expiryStr) {
                    if (!expiryStr || expiryStr === '-') return null;
                    try {
                        const date = new Date(expiryStr);
                        const now = new Date();
                        const diffTime = date - now;
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        return diffDays >= 0 ? diffDays : null;
                    } catch (e) {
                        // Try parsing different formats
                        const match = expiryStr.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})/);
                        if (match) {
                            const day = parseInt(match[1]);
                            const month = parseInt(match[2]) - 1;
                            const year = parseInt(match[3].length === 2 ? '20' + match[3] : match[3]);
                            const date = new Date(year, month, day);
                            const now = new Date();
                            const diffTime = date - now;
                            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                            return diffDays >= 0 ? diffDays : null;
                        }
                        return null;
                    }
                }
            } catch (error) {
                console.error('Error loading admins:', error);
            }
        }

        async function refreshData(userId, buttonElement) {
            try {
                // Find the button if not provided
                let button = buttonElement;
                if (!button) {
                    // Try to find button by userId in the table
                    const buttons = document.querySelectorAll(`button[onclick*="${userId}"]`);
                    if (buttons.length > 0) {
                        button = buttons[0];
                    }
                }
                
                if (button) {
                    button.disabled = true;
                    button.textContent = 'Refreshing...';
                }
                
                const response = await fetch(`http://localhost:3000/refresh-dashboard/${userId}`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ ' + result.message);
                    loadAdmins();
                } else {
                    alert('‚ö†Ô∏è ' + result.message);
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            } finally {
                // Find and re-enable the button
                const buttons = document.querySelectorAll(`button[onclick*="${userId}"]`);
                buttons.forEach(btn => {
                    btn.disabled = false;
                    btn.textContent = 'Refresh';
                });
            }
        }
        
        async function refreshAllData() {
            try {
                const response = await fetch('http://localhost:3000/get-admins');
                const admins = await response.json();
                
                let successCount = 0;
                let failCount = 0;
                
                for (const admin of admins) {
                    try {
                        const refreshResponse = await fetch(`http://localhost:3000/refresh-dashboard/${admin.phoneNumber || admin.id}`, {
                            method: 'POST'
                        });
                        const result = await refreshResponse.json();
                        if (result.success) {
                            successCount++;
                        } else {
                            failCount++;
                        }
                    } catch (e) {
                        failCount++;
                    }
                }
                
                alert(`Refresh complete: ${successCount} successful, ${failCount} failed`);
                loadAdmins();
            } catch (error) {
                alert('‚ùå Error refreshing data: ' + error.message);
            }
        }

        window.onclick = function(event) {
            const modal = document.getElementById('modal');
            if (event.target === modal) {
                closeModal();
            }
        }

        loadAdmins();
    </script>
</body>
</html>

