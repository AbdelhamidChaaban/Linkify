const puppeteer = require('puppeteer-extra');
const StealthPlugin = require('puppeteer-extra-plugin-stealth');
const { getCredentials, getSession, saveSession } = require('./firebase-db');

puppeteer.use(StealthPlugin());

(async () => {
  const browser = await puppeteer.launch({ headless: false }); // üëÅÔ∏è Browser stays visible
  const page = await browser.newPage();

  try {
    // Check for existing session first
    console.log('üîç Checking for existing session...');
    const savedSession = await getSession();
    
    let needsLogin = true;
    
    if (savedSession && savedSession.cookies && savedSession.cookies.length > 0) {
      console.log('‚úÖ Found saved session. Attempting to restore...');
      
      // Set cookies before navigating
      await page.setCookie(...savedSession.cookies);
      
      // Navigate to dashboard directly
      try {
        await page.goto('https://www.alfa.com.lb/en/dashboard', {
          waitUntil: 'domcontentloaded',
          timeout: 30000
        });
        
        // Check if we're still on login page (session expired)
        const currentUrl = page.url();
        if (currentUrl.includes('/login')) {
          console.log('‚ö†Ô∏è Session expired. Need to login again.');
          needsLogin = true;
        } else {
          console.log('‚úÖ Session restored successfully! Using cached login.');
          needsLogin = false;
        }
      } catch (error) {
        console.log('‚ö†Ô∏è Error checking session, will proceed with login:', error.message);
        needsLogin = true;
      }
    }
    
    if (needsLogin) {
      console.log('üîê Starting login process...');
      
      // Get credentials from Firebase
      const credentials = await getCredentials();
      console.log('‚úÖ Credentials retrieved from database');
      
      // Navigate to login page
      await page.goto('https://www.alfa.com.lb/en/account/login', {
        waitUntil: 'domcontentloaded',
        timeout: 60000
      });

      console.log('‚úÖ Login page loaded. Waiting for form...');

      await page.waitForSelector('#Username', { timeout: 15000 });
      await page.type('#Username', credentials.username);
      await page.type('#Password', credentials.password);

      // ‚úÖ Automatically click the Sign In button
      await page.click('button[type="submit"]');

      console.log('‚è∏Ô∏è Login submitted. Waiting for login to complete...');
      
      // Wait for navigation after login (either dashboard or still on login if CAPTCHA)
      try {
        await page.waitForNavigation({ waitUntil: 'domcontentloaded', timeout: 30000 });
        
        const currentUrl = page.url();
        if (!currentUrl.includes('/login')) {
          // Successfully logged in!
          console.log('‚úÖ Login successful! Saving session to database...');
          
          // Get all cookies
          const cookies = await page.cookies();
          
          // Extract any tokens from localStorage/sessionStorage if needed
          const tokens = await page.evaluate(() => {
            return {
              // Add any token extraction logic here if the site stores tokens
              // For example: localStorage.getItem('authToken')
            };
          });
          
          // Save session to Firebase
          await saveSession(cookies, tokens);
          console.log('‚úÖ Session saved successfully!');
        } else {
          console.log('‚è∏Ô∏è Still on login page. Please complete CAPTCHA manually...');
        }
      } catch (error) {
        console.log('‚è∏Ô∏è Waiting for navigation or CAPTCHA completion...');
      }
    }
    
    console.log('‚è∏Ô∏è Browser will stay open for manual inspection...');
    await new Promise(() => {}); // Keeps browser open indefinitely
    
  } catch (error) {
    console.error('‚ùå Error:', error);
    await browser.close();
    process.exit(1);
  }
})();